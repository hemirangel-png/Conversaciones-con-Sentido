<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Conversaciones con Sentido</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
    }
    
    .bg-overlay {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(5px);
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
  </style>
</head>
<body class="min-h-screen py-8 px-4">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-light text-gray-800 mb-2">
        Dashboard de Solicitudes
      </h1>
      <p class="text-lg text-gray-600">
        Conversaciones con Sentido - Acompañamiento terapéutico y espiritual
      </p>
      <p class="text-sm text-gray-500 mt-2">
        Estadísticas y registro de solicitudes recibidas
      </p>
    </div>

    <!-- Estadísticas Principales -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="stat-card rounded-xl p-6 shadow-lg text-center">
        <div class="text-3xl font-bold text-green-600 mb-2" id="total-solicitudes">0</div>
        <div class="text-gray-600">Total Solicitudes</div>
      </div>
      
      <div class="stat-card rounded-xl p-6 shadow-lg text-center">
        <div class="text-3xl font-bold text-blue-600 mb-2" id="solicitudes-mes">0</div>
        <div class="text-gray-600">Este Mes</div>
      </div>
      
      <div class="stat-card rounded-xl p-6 shadow-lg text-center">
        <div class="text-3xl font-bold text-purple-600 mb-2" id="solicitudes-hoy">0</div>
        <div class="text-gray-600">Hoy</div>
      </div>
      
      <div class="stat-card rounded-xl p-6 shadow-lg text-center">
        <div class="text-3xl font-bold text-orange-600 mb-2" id="tasa-conversion">0%</div>
        <div class="text-gray-600">Tasa Conversión</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Gráfico de Servicios -->
      <div class="stat-card rounded-xl p-6 shadow-lg">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Servicios Solicitados</h3>
        <canvas id="serviciosChart" height="250"></canvas>
      </div>

      <!-- Gráfico por Países -->
      <div class="stat-card rounded-xl p-6 shadow-lg">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Solicitudes por País</h3>
        <canvas id="paisesChart" height="250"></canvas>
      </div>
    </div>

    <!-- Tabla de Solicitudes Recientes -->
    <div class="stat-card rounded-xl p-6 shadow-lg mb-8">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-gray-800">Solicitudes Recientes</h3>
        <button onclick="cargarSolicitudes()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
          Actualizar
        </button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-600">
          <thead class="text-xs text-gray-700 uppercase bg-gray-50">
            <tr>
              <th class="px-4 py-3">Fecha</th>
              <th class="px-4 py-3">Nombre</th>
              <th class="px-4 py-3">Servicio</th>
              <th class="px-4 py-3">País</th>
              <th class="px-4 py-3">Estado</th>
              <th class="px-4 py-3">Acciones</th>
            </tr>
          </thead>
          <tbody id="solicitudes-table">
            <!-- Las solicitudes se cargarán aquí -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Exportar Datos -->
    <div class="stat-card rounded-xl p-6 shadow-lg text-center">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Exportar Datos</h3>
      <div class="flex flex-wrap gap-4 justify-center">
        <button onclick="exportarCSV()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
          Exportar CSV
        </button>
        <button onclick="exportarJSON()" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
          Exportar JSON
        </button>
        <button onclick="limpiarRegistros()" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
          Limpiar Registros
        </button>
      </div>
    </div>
  </div>

  <script>
    // Cargar datos al iniciar
    document.addEventListener('DOMContentLoaded', function() {
      cargarSolicitudes();
    });

    function cargarSolicitudes() {
      // Obtener todas las solicitudes del localStorage
      const solicitudes = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('solicitud:')) {
          const solicitud = JSON.parse(localStorage.getItem(key));
          solicitud.id = key;
          solicitudes.push(solicitud);
        }
      }

      // Ordenar por fecha (más reciente primero)
      solicitudes.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

      // Actualizar estadísticas
      actualizarEstadisticas(solicitudes);
      
      // Actualizar tabla
      actualizarTabla(solicitudes);
      
      // Actualizar gráficos
      actualizarGraficos(solicitudes);
    }

    function actualizarEstadisticas(solicitudes) {
      const total = solicitudes.length;
      const hoy = new Date().toDateString();
      const esteMes = new Date().getMonth() + '-' + new Date().getFullYear();
      
      const solicitudesHoy = solicitudes.filter(s => 
        new Date(s.fecha).toDateString() === hoy
      ).length;
      
      const solicitudesMes = solicitudes.filter(s => {
        const fechaSolicitud = new Date(s.fecha);
        return (fechaSolicitud.getMonth() + '-' + fechaSolicitud.getFullYear()) === esteMes;
      }).length;

      document.getElementById('total-solicitudes').textContent = total;
      document.getElementById('solicitudes-hoy').textContent = solicitudesHoy;
      document.getElementById('solicitudes-mes').textContent = solicitudesMes;
      document.getElementById('tasa-conversion').textContent = 'N/A';
    }

    function actualizarTabla(solicitudes) {
      const tbody = document.getElementById('solicitudes-table');
      tbody.innerHTML = '';

      solicitudes.slice(0, 10).forEach(solicitud => {
        const fecha = new Date(solicitud.fecha).toLocaleDateString('es-ES');
        const tr = document.createElement('tr');
        tr.className = 'bg-white border-b hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-4 py-3">${fecha}</td>
          <td class="px-4 py-3 font-medium">${solicitud.nombre || 'N/A'}</td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
              ${solicitud.servicio || 'No especificado'}
            </span>
          </td>
          <td class="px-4 py-3">${solicitud.pais || 'N/A'}</td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Nuevo</span>
          </td>
          <td class="px-4 py-3">
            <button onclick="verDetalles('${solicitud.id}')" class="text-blue-600 hover:text-blue-800 mr-2">
              Ver
            </button>
            <button onclick="marcarContactado('${solicitud.id}')" class="text-green-600 hover:text-green-800">
              Contactado
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function actualizarGraficos(solicitudes) {
      // Gráfico de servicios
      const serviciosCount = {};
      solicitudes.forEach(s => {
        const servicio = s.servicio || 'No especificado';
        serviciosCount[servicio] = (serviciosCount[servicio] || 0) + 1;
      });

      const serviciosCtx = document.getElementById('serviciosChart').getContext('2d');
      new Chart(serviciosCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(serviciosCount),
          datasets: [{
            data: Object.values(serviciosCount),
            backgroundColor: ['#10B981', '#3B82F6', '#8B5CF6', '#F59E0B', '#EF4444']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });

      // Gráfico de países (top 10)
      const paisesCount = {};
      solicitudes.forEach(s => {
        const pais = s.pais || 'No especificado';
        paisesCount[pais] = (paisesCount[pais] || 0) + 1;
      });

      const paisesSorted = Object.entries(paisesCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      const paisesCtx = document.getElementById('paisesChart').getContext('2d');
      new Chart(paisesCtx, {
        type: 'bar',
        data: {
          labels: paisesSorted.map(p => p[0]),
          datasets: [{
            label: 'Solicitudes',
            data: paisesSorted.map(p => p[1]),
            backgroundColor: '#10B981'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function verDetalles(id) {
      const solicitud = JSON.parse(localStorage.getItem(id));
      const detalles = `
Nombre: ${solicitud.nombre}
Email: ${solicitud.email}
Teléfono: ${solicitud.telefono}
País: ${solicitud.pais}
Servicio: ${solicitud.servicio}
Fecha: ${new Date(solicitud.fecha).toLocaleString()}

--- Respuestas ---
Visión del cambio: ${solicitud.sinProblema}
Nombre dificultad: ${solicitud.nombreDificultad}
Tiempo presente: ${solicitud.tiempoPresente}
Cómo controlas: ${solicitud.comoControlas}
Fortalezas: ${solicitud.fortalezasOtros}
Opción elegida: ${solicitud.opcionElegida}
Pregunta fundamental: ${solicitud.preguntaFundamental}
      `;
      alert(detalles);
    }

    function marcarContactado(id) {
      const solicitud = JSON.parse(localStorage.getItem(id));
      solicitud.estado = 'contactado';
      solicitud.fechaContacto = new Date().toISOString();
      localStorage.setItem(id, JSON.stringify(solicitud));
      cargarSolicitudes();
      alert('Solicitud marcada como contactada');
    }

    function exportarCSV() {
      const solicitudes = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('solicitud:')) {
          solicitudes.push(JSON.parse(localStorage.getItem(key)));
        }
      }

      if (solicitudes.length === 0) {
        alert('No hay datos para exportar');
        return;
      }

      const headers = ['Fecha', 'Nombre', 'Email', 'Teléfono', 'País', 'Servicio', 'Estado'];
      const csv = [
        headers.join(','),
        ...solicitudes.map(s => [
          new Date(s.fecha).toLocaleDateString('es-ES'),
          `"${s.nombre || ''}"`,
          `"${s.email || ''}"`,
          `"${s.telefono || ''}"`,
          `"${s.pais || ''}"`,
          `"${s.servicio || ''}"`,
          `"${s.estado || 'nuevo'}"`
        ].join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `solicitudes-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportarJSON() {
      const solicitudes = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('solicitud:')) {
          solicitudes.push(JSON.parse(localStorage.getItem(key)));
        }
      }

      if (solicitudes.length === 0) {
        alert('No hay datos para exportar');
        return;
      }

      const blob = new Blob([JSON.stringify(solicitudes, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `solicitudes-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function limpiarRegistros() {
      if (confirm('¿Estás seguro de que quieres eliminar todos los registros? Esta acción no se puede deshacer.')) {
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('solicitud:')) {
            localStorage.removeItem(key);
          }
        }
        cargarSolicitudes();
        alert('Todos los registros han sido eliminados');
      }
    }
  </script>
</body>
</html>
